<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册页面</title>

    <link rel="stylesheet" href="./js/element-lib/theme-chalk/index.css">
    <script src="./js/vue.js"></script>
    <script src="./js/element-lib/index.js"></script>
    <script src="./js/axios-0.18.0.js"></script>
    <script src="./js/axios-intercept.js"></script>

    <style>
        body {
            width: 100vw;
            height: 100vh;

            /* 设置容器水平分布 */
            display: flex;
            /* 设置页面元素居中 */
            justify-content: center;
            align-items: center;
        }

    </style>


</head>

<body>
<div id="app">

    <div>

        <el-form :model="ruleForm" status-icon :rules="rules" ref="ruleForm" label-width="80px" label-position="left">

            <el-form-item label="用户名" prop="name">
                <el-input v-model="ruleForm.name"></el-input>
            </el-form-item>

            <el-form-item label="密码" prop="pass">
                <el-input type="password" v-model="ruleForm.pass" autocomplete="off"></el-input>
            </el-form-item>

            <el-form-item label="确认密码" prop="checkPass">
                <el-input type="password" v-model="ruleForm.checkPass" autocomplete="off"></el-input>
            </el-form-item>

        </el-form>
    </div>

    <div>
        <el-form label-width="80px" label-position="left" :inline="true">

            <el-form-item label="验证码">
                <el-input v-model="code"></el-input>
            </el-form-item>

            <el-button style="width: 75px; ;height: 40px;" @click="getCheckCode">{{checkCode}}</el-button>

        </el-form>
    </div>

    <div style=" display: flex;justify-content: center;">
        <span style="margin-right: 60px">
            <el-button type="primary" @click="submitForm('ruleForm')">提交</el-button>
        </span>

        <span>
            <el-button @click="resetForm('ruleForm')">重置</el-button>
        </span>
    </div>

</div>

</body>

<script>
    new Vue({
            el: "#app",

            mounted() {
                this.getCheckCode();
            },

            data() {
                var validatePass = (rule, value, callback) => {
                    if (value === '') {
                        callback(new Error('请输入密码'));
                    } else {
                        if (this.ruleForm.checkPass !== '') {
                            this.$refs.ruleForm.validateField('checkPass');
                        }
                        callback();
                    }
                };
                var validatePass2 = (rule, value, callback) => {
                    if (value === '') {
                        callback(new Error('请再次输入密码'));
                    } else if (value !== this.ruleForm.pass) {
                        callback(new Error('两次输入密码不一致!'));
                    } else {
                        callback();
                    }
                };

                var validateUsername = async (rule, value, callback) => {
                    if (value === '') {
                        callback(new Error('请输入用户名'));
                    } else {
                        const res = await axios.get("http://localhost:8081/users/validate/" + value);
                        if (res.data.code == 0) {
                            callback(new Error(res.data.msg));
                        } else {
                            callback()
                        }
                    }
                };

                return {
                    ruleForm: {
                        name: '',
                        pass: '',
                        checkPass: '',
                    },
                    rules: {
                        name: [
                            {validator: validateUsername, trigger: 'blur'}
                        ],
                        pass: [
                            {validator: validatePass, trigger: 'blur'}
                        ],
                        checkPass: [
                            {validator: validatePass2, trigger: 'blur'}
                        ],
                    },
                    code: '',
                    checkCode: ''
                };
            },
            methods: {
                submitForm(formName) {
                    this.$refs[formName].validate((valid) => {
                        if (valid) {

                            if(this.code == null||this.code ===''){
                                this.$message.error("请输入验证码！")
                                return false
                            }
                            if (this.checkCode !== this.code){
                                this.$message.error("验证码错误！")
                                return false
                            }

                            const user = {
                                username: this.ruleForm.name,
                                password: this.ruleForm.pass
                            }

                            axios.post("http://localhost:8081/users/register", user)
                                .then(res => {
                                    if (res.data.code == 1) {

                                        //成功
                                        this.$message({
                                            message: '注册成功！',
                                            type: 'success'
                                        });

                                        setTimeout('location.href="./login.html"', 3000)

                                    } else {
                                        //失败
                                        this.$message.error(res.data.msg)
                                    }
                                })

                        } else {
                            return false;
                        }
                    });
                },
                resetForm(formName) {
                    this.$refs[formName].resetFields();
                },

                getCheckCode() {
                    axios.get("http://localhost:8081/users/code")
                        .then(res => {
                            this.checkCode = res.data.data;
                        })
                }

            }
        }
    )

</script>

</html>