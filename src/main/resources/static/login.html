<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录页面</title>

    <link rel="stylesheet" href="./js/element-lib/theme-chalk/index.css">
    <script src="./js/vue.js"></script>
    <script src="./js/element-lib/index.js"></script>
    <script src="./js/axios-0.18.0.js"></script>
    <script src="./js/axios-intercept.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: 0;
        }

        html {
            font-size: 10px;
        }

        body {
            width: 100vw;
            height: 100vh;
            /* 设置容器水平分布 */
            display: flex;
            /* 设置页面元素居中 */
            justify-content: center;
            align-items: center;
        }
    </style>

</head>

<body>

<div id="app">

    <div>
        <el-form :model="user" status-icon :rules="rules" ref="user" label-width="80px" label-position="left">

            <el-form-item label="用户名:" prop="username">
                <el-input v-model="user.username"></el-input>
            </el-form-item>

            <el-form-item label="密码:" prop="password">
                <el-input type="password" v-model="user.password"></el-input>
            </el-form-item>

            <el-form-item label="用户类型">
                <el-radio-group v-model="user.permission">
                    <el-radio label="0">普通用户</el-radio>
                    <el-radio label="1">管理员</el-radio>
                </el-radio-group>
            </el-form-item>


        </el-form>

    </div>

    <div>
        <el-form label-width="80px" label-position="left" :inline="true">

            <el-form-item label="验证码">
                <el-input v-model="code"></el-input>
            </el-form-item>

            <el-button style="width: 75px; ;height: 40px;" @click="getCheckCode">{{checkCode}}</el-button>

        </el-form>
    </div>

    <div style=" display: flex;justify-content: center;">
            <span style="margin-right: 60px">
                <el-button @click="login('user')">登录</el-button>
            </span>

        <span>
                <el-button @click="register">注册</el-button>
            </span>

    </div>

</div>
</body>
<script>

    new Vue({
        el: "#app",
        mounted() {
            this.getCheckCode()
        },
        data() {

            var validateUsername = (rule, value, callback) => {
                if (value === '') {
                    callback(new Error('请输入用户名'));
                } else {
                    callback();
                }
            };
            var validatePass = (rule, value, callback) => {
                if (value === '') {
                    callback(new Error('请输入密码'));
                } else {
                    callback();
                }
            };

            return {
                user: {
                    username: '',
                    password: '',
                    permission: "0"
                },
                rules: {
                    username: [
                        {validator: validateUsername, trigger: 'blur'}
                    ],
                    password: [
                        {validator: validatePass, trigger: 'blur'}
                    ]
                },
                checkCode: '',
                code: ''
            }

        },
        methods: {
            login(user) {
                this.$refs[user].validate((valid) => {
                    if (valid) {

                        if (this.code == null || this.code === '') {
                            this.$message.error("请输入验证码！")
                            return false
                        }
                        if (this.checkCode !== this.code) {
                            this.$message.error("验证码错误！")
                            this.getCheckCode()
                            return false
                        }

                        axios.post("http://localhost:8081/users/login", this.user)
                            .then(res => {
                                if (res.data) {
                                    //成功
                                    sessionStorage.setItem('token', res.data)
                                    this.$message({
                                        message: '登录成功！',
                                        type: 'success'
                                    });
                                    setTimeout(() => {
                                        location.href = './index.html'
                                    }, 500)
                                }
                            }).catch(err => {
                            this.getCheckCode()
                            this.$message.error(err)
                        })
                    } else {
                        return false;
                    }
                });
            },

            register() {
                // 跳转
                location.href = "./register.html"
            },

            getCheckCode() {
                axios.get("http://localhost:8081/users/code")
                    .then(res => {
                        this.checkCode = res.data;
                    }).catch(err=>{
                    this.$message.error(err)
                })
            }

        }
    })
</script>

</html>